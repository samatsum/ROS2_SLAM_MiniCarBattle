# ログ生成システムと courseLog の仕組み

このドキュメントでは、`gap_follow` パッケージがどのようにして走行データ (`courseLog`) を記録・生成しているかについて、その**目的**と**仕組み**を詳細に解説します。

## 1. ログ作成の目的 (Why?)

このシステムの最大の目的は、単に走行記録を残すことではなく、**「実機で作ろうとしている『マウスセンサーによる自己位置推定（Dead Reckoning）』が、正しく動くか検証するため」** です。

シミュレータ上では、`Odometry`（神の視点からの正確な位置）が得られます。しかし、実機ではそんな便利なものはありません。実機にあるのは「非力なマウスセンサー」だけです。

そこで、このログシステムは以下のことを行っています：

1.  **「もし実機マウスで走っていたら、どんなデータが取れていたか？」** をシミュレータの正確なデータから逆算して生成する（Mickeyデータの生成）。
2.  **「そのマウスデータだけで、元の走行軌跡を再現できるか？」** を計算して検証する（DR経路の復元）。
3.  **「復元した軌跡とLiDARデータを合わせれば、地図が作れるか？」** を可視化する。

つまり、**実機アルゴリズムの予行演習** をログ生成時に毎回行っているのです。

---

## 2. ログ生成の流れ (How?)

プログラム (`data_logger.py`) は、走行中に常にデータを蓄え続け、終了時（Ctrl+C または クラッシュ（壁にぶつかった時のことよん♡）時）に一気に解析・保存を行います。

### Step 1: データの収集 (Recording)
走行中、以下のデータをメモリに貯め込みます。
*   **Odometry (真値)**: 車の正確なワールド座標 $(x, y)$ とワールド向き $\theta$。
*   **LiDAR Scan**: 周囲の壁までの距離データ。

### Step 2: Mickeyデータの生成 (Simulation)
ログ保存の瞬間、蓄積した `Odometry` データ（真値）を使って、マウスセンサーの挙動(すべてローカル座標)をシミュレートします。

*   **なぜやるのか？**: 実機では $500\text{Hz}$ (0.002秒ごと) でマウスからデータが来ますが、ROSのデータはもっと粗いです。そこで、**線形補間** という数学的な処理を使って、「0.002秒ごとの精密な車の位置」をまず復元します。
*   **マウスの動きへの変換**: 復元した車の動きを、前輪と後輪に取り付けたマウスセンサーの動き（ローカル座標系での変位 $\Delta x, \Delta y$）に変換します。

こうして作られるのが `mickey_front.csv`, `mickey_rear.csv` です。これは「実機で取れるはずのミッキーデータ」のコピーです。

### Step 3: 自己位置推定の復元 (Reconstruction)
次に、**「今作った Mickeyデータだけ」** を見て、車がどう走ったかを計算し直します（Dead Reckoning）。

*   **ルール**: ここでは答え（Odometry）を見ることは禁止です。マウスの変位量だけで $\theta$（向き）を計算し、「今こっちに進んでいるはずだ」と推測を積み重ねていきます。
*   **目的**: この計算ロジックが正しければ、計算結果の軌跡は、本来の軌跡と（ほぼ）重なるはずです。

### Step 4: 可視化と検証 (Visualization)
最後に、結果を画像として出力します。

*   **`trajectory_map.png`**:
    *   **赤/青線**: Odometry（真値）の軌跡。
    *   **目的**: 実際にどう走ったかの確認。

*   **`kinematics.png`**:
    *   **シアン色の太線**: Mickeyデータから復元した推定軌跡 (DR Path)。
    *   **背景の薄い線**: Odometry（真値）。
    *   **目的**: **「推定」と「正解」の答え合わせ**。この2本の線が重なっていれば、自己位置推定アルゴリズムは優秀と言えます。ズレていれば、アルゴリズムの改良が必要です。

*   **`mickey_lidar_points.png`**:
    *   **点群**: 推定された位置から見たLiDARデータをプロットして地図を描いたもの。
    *   **目的**: 自己位置推定がズレていないかの最終確認。推定位置が正しければ、壁のラインがきれいに繋がります。推定がズレていると、壁が二重に見えたり歪んだりします。

---

## 3. 生成されるファイルまとめ

| ファイル/フォルダ | 説明 |
| :--- | :--- |
| `initial_pose.yaml` | スタート地点の正確な座標（DR計算の開始点として使用）。 |
| `mickey/` | 実機マウスセンサーを模倣して生成されたCSVデータ。 |
| `images/trajectory_map.png` | **【正解データ】** 実際にシミュレータ上で車が通った道。 |
| `images/kinematics.png` | **【答え合わせ】** マウスデータから計算した「推定軌跡」と「正解」の比較図。 |
| `images/mickey_lidar_points.png` | **【応用検証】** 推定軌跡を使ってLiDARデータを並べ直した地図。 |

このシステムのおかげで、実機を走らせる前に、計算ロジック（`calculate_dead_reckoning_path` 関数）のバグや性能限界をPC上で安全に確認することができるのです。
